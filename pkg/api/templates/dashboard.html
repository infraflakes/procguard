<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Bảng điều khiển ProcGuard</title>
  <style>
    body{font-family:Arial,background:#f76f53;color:#000;margin:0;padding:2rem}
    button{background:#0bf;border:0;padding:.5rem 1rem;border-radius:4px;cursor:pointer}
    #results, #blocklist-items, #web-log-items{height:400px;overflow-y:scroll;background:#e6e6e6;padding:1rem;font-size:13px;}
    #search-container, #blocklist-controls, #time-filter-container{margin-bottom: 1rem;}
    #time-filter-container > * { margin-right: 1rem; }
    nav > button { background: #333; color: #fff; }
    .status-message { margin-left: 1rem; padding: 5px; background: #333; color: #fff; border-radius: 3px; }
    .result-item { margin-bottom: 5px; }
    body > div { margin-top: 2rem; }
    .modal { position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); margin-top: 0; }
    .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; }
    .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .big-button { padding: 1rem 2rem; font-size: 1.2rem; margin: 1rem; }
  </style>
</head>
<body>
  <nav>
    <button onclick="showTopLevelView('welcome-view')">Trang chủ</button>
    <button onclick="showTopLevelView('settings-view')">Cài đặt</button>
    <button onclick="window.location.href='/logout'" style="float: right;">Đăng xuất</button>
  </nav>

  <div id="welcome-view">
    <h2>Chào mừng đến với ProcGuard</h2>
    <p>Chọn một mục để bắt đầu:</p>
    <button class="big-button" onclick="showTopLevelView('app-management-view')">Quản lý Ứng dụng</button>
    <button class="big-button" onclick="showTopLevelView('web-management-view')">Quản lý Web</button>
  </div>

  <div id="app-management-view" style="display:none;">
    <div class="sub-nav">
      <button onclick="showSubView('search-view', 'app-management-view')">Tìm kiếm</button>
      <button onclick="showSubView('blocklist-view', 'app-management-view')">Xem ứng dụng bị chặn</button>
    </div>
    <div id="search-view">
      <h2>Bảng điều khiển ProcGuard</h2>
      <div id="search-container">
        <input id="q" placeholder="nhập tên ứng dụng">
        <button onclick="search()">Tìm kiếm Log</button>
        <button onclick="block()">Chặn mục đã chọn</button>
        <span id="block-status" class="status-message"></span>
      </div>
      <div id="time-filter-container">
          <span>Lọc theo thời gian:</span>
          <button onclick="search({since: '1 hour ago', until: 'now'})">1 giờ qua</button>
          <button onclick="search({since: '24 hours ago', until: 'now'})">24 giờ qua</button>
          <button onclick="search({since: '7 days ago', until: 'now'})">7 ngày qua</button>
          <br>
          <span>Từ: </span><input type="date" id="since_date"> <input type="time" id="since_time" step="60">
          <span>Đến: </span><input type="date" id="until_date"> <input type="time" id="until_time" step="60">
          <button onclick="search()">Xác nhận</button>
      </div>
      <h3>Kết quả tìm kiếm</h3>
      <div id="results"></div>
    </div>
    <div id="blocklist-view" style="display:none;">
      <h2>Các ứng dụng bị chặn</h2>
      <div id="blocklist-controls">
          <button onclick="unblockSelected()">Bỏ chặn mục đã chọn</button>
          <button onclick="clearBlocklist()" style="background-color: #d9534f;">Xóa toàn bộ danh sách chặn</button>
          <button onclick="saveBlocklist()">Lưu danh sách chặn</button>
          <button onclick="document.getElementById('load-input').click()">Tải lên danh sách chặn</button>
          <input type="file" id="load-input" style="display: none;" onchange="loadBlocklistFile(event)">
          <span id="unblock-status" class="status-message"></span>
      </div>
      <div id="blocklist-items"></div>
    </div>
  </div>

  <div id="web-management-view" style="display:none;">
    <div class="sub-nav">
      <button onclick="showSubView('web-log-view', 'web-management-view')">Lịch sử Web</button>
      <button onclick="showSubView('web-blocklist-view', 'web-management-view')">Danh sách chặn</button>
    </div>
    <div id="web-log-view" style="display:none;">
      <h2>Lịch sử Truy cập Web</h2>
      <div id="web-log-controls">
        <button onclick="blockSelectedWebsites()">Chặn mục đã chọn</button>
      </div>
      <div id="web-time-filter-container">
          <span>Lọc theo thời gian:</span>
          <button onclick="searchWebLogs({since: '1 hour ago', until: 'now'})">1 giờ qua</button>
          <button onclick="searchWebLogs({since: '24 hours ago', until: 'now'})">24 giờ qua</button>
          <button onclick="searchWebLogs({since: '7 days ago', until: 'now'})">7 ngày qua</button>
          <br>
          <span>Từ: </span><input type="date" id="web_since_date"> <input type="time" id="web_since_time" step="60">
          <span>Đến: </span><input type="date" id="web_until_date"> <input type="time" id="web_until_time" step="60">
          <button onclick="searchWebLogs()">Xác nhận</button>
      </div>
      <div id="web-log-items"></div>
    </div>
    <div id="web-blocklist-view" style="display:none;">
      <h2>Quản lý Danh sách chặn Web</h2>
      <div id="web-blocklist-controls">
          <button onclick="unblockSelectedWebsites()">Bỏ chặn mục đã chọn</button>
          <button onclick="clearWebBlocklist()" style="background-color: #d9534f;">Xóa toàn bộ danh sách chặn</button>
          <button onclick="saveWebBlocklist()">Lưu danh sách chặn</button>
          <button onclick="document.getElementById('load-web-input').click()">Tải lên danh sách chặn</button>
          <input type="file" id="load-web-input" style="display: none;" onchange="loadWebBlocklistFile(event)">
          <span id="unblock-web-status" class="status-message"></span>
      </div>
      <div id="web-blocklist-items"></div>
    </div>
  </div>

  <div id="settings-view" style="display:none;">
    <h2>Cài đặt</h2>
    <div id="settings-controls">
        <div id="autostart-settings">
            <h4>Khởi động cùng Windows</h4>
            <p>Trạng thái: <b id="autostart-status">Không rõ</b></p>
            <button id="autostart-toggle-btn" onclick="toggleAutostart()">Toggle</button>
        </div>
        <hr>
        <button onclick="uninstall()" style="background-color: #d9534f;">Gỡ cài đặt ProcGuard</button>
        <p><b>Cảnh báo:</b> Thao tác này sẽ xóa toàn bộ dữ liệu và gỡ cài đặt ProcGuard khỏi hệ thống.</p>
    </div>
  </div>

  <div id="uninstall-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close-button" onclick="closeUninstallModal()">&times;</span>
      <h3>Xác nhận gỡ cài đặt</h3>
      <p>Vui lòng nhập mật khẩu của bạn để tiếp tục.</p>
      <form id="uninstall-form">
        <input type="password" id="uninstall-password" placeholder="Mật khẩu" required>
        <button type="submit">Xác nhận</button>
      </form>
      <p id="uninstall-error" class="error-message" style="display: none;"></p>
    </div>
  </div>

  <script>
    const results = document.getElementById('results');
    const q = document.getElementById('q');
    const sinceDateInput = document.getElementById('since_date');
    const sinceTimeInput = document.getElementById('since_time');
    const untilDateInput = document.getElementById('until_date');
    const untilTimeInput = document.getElementById('until_time');
    const webSinceDateInput = document.getElementById('web_since_date');
    const webSinceTimeInput = document.getElementById('web_since_time');
    const webUntilDateInput = document.getElementById('web_until_date');
    const webUntilTimeInput = document.getElementById('web_until_time');
    const blocklistItems = document.getElementById('blocklist-items');
    const uninstallModal = document.getElementById('uninstall-modal');
    const uninstallForm = document.getElementById('uninstall-form');
    const uninstallPasswordInput = document.getElementById('uninstall-password');
    const uninstallError = document.getElementById('uninstall-error');
    const blockStatus = document.getElementById('block-status');
    const unblockStatus = document.getElementById('unblock-status');
    const extensionStatus = document.getElementById('extension-status');
    const installExtensionBtn = document.getElementById('install-extension-btn');
    const webBlocklistItems = document.getElementById('web-blocklist-items');
    const webLogItems = document.getElementById('web-log-items');
    const autostartStatusEl = document.getElementById('autostart-status');
    const autostartToggleBtn = document.getElementById('autostart-toggle-btn');

    let isAutostartEnabled = false;

    const EXTENSION_ID = 'ilaocldmkhlifnikhinkmiepekpbefoh';

    const topLevelViews = ['welcome-view', 'app-management-view', 'web-management-view', 'settings-view'];
    const appSubViews = ['search-view', 'blocklist-view'];
    const webSubViews = ['web-log-view', 'web-blocklist-view'];

    function setDefaults() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const today = `${year}-${month}-${day}`;
        sinceDateInput.value = today;
        untilDateInput.value = today;
        webSinceDateInput.value = today;
        webUntilDateInput.value = today;
    }

    async function loadAutostartStatus() {
        try {
            const res = await fetch('/api/settings/autostart/status');
            if (!res.ok) {
                autostartStatusEl.textContent = "Không hỗ trợ trên HĐH này";
                autostartToggleBtn.disabled = true;
                return;
            }
            const data = await res.json();
            isAutostartEnabled = data.enabled;
            autostartStatusEl.textContent = isAutostartEnabled ? "Đã bật" : "Đã tắt";
            autostartToggleBtn.textContent = isAutostartEnabled ? "Tắt tự động khởi động" : "Bật tự động khởi động";
            autostartToggleBtn.disabled = false;
        } catch (e) {
            autostartStatusEl.textContent = "Lỗi khi tải trạng thái";
            autostartToggleBtn.disabled = true;
        }
    }

    async function toggleAutostart() {
        const endpoint = isAutostartEnabled ? '/api/settings/autostart/disable' : '/api/settings/autostart/enable';
        try {
            autostartToggleBtn.disabled = true;
            const res = await fetch(endpoint, { method: 'POST' });
            if (!res.ok) {
                const errorText = await res.text();
                alert(`Thao tác thất bại: ${errorText}`);
            } else {
                await loadAutostartStatus(); // Refresh status after action
            }
        } catch (e) {
            alert(`Đã xảy ra lỗi: ${e.message}`);
        } finally {
            autostartToggleBtn.disabled = false;
        }
    }

    function showTopLevelView(viewName) {
        topLevelViews.forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        document.getElementById(viewName).style.display = 'block';

        // Load content for the default subview if applicable
        if (viewName === 'app-management-view') {
          showSubView('search-view', 'app-management-view');
        } else if (viewName === 'web-management-view') {
          showSubView('web-log-view', 'web-management-view');
        } else if (viewName === 'settings-view') {
          loadAutostartStatus();
        }
    }

    function showSubView(viewName, parentView) {
      let subviews;
      if (parentView === 'app-management-view') {
        subviews = appSubViews;
      } else if (parentView === 'web-management-view') {
        subviews = webSubViews;
      }

      subviews.forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
      document.getElementById(viewName).style.display = 'block';

      if (viewName === 'blocklist-view') {
          loadBlocklist();
      } else if (viewName === 'web-blocklist-view') {
          loadWebBlocklist();
      } else if (viewName === 'web-log-view') {
          loadWebLogs();
      }
    }

    async function searchWebLogs(range) {
        let since = '';
        let until = '';

        if (range) {
            since = range.since;
            until = range.until;
        } else {
            if (webSinceDateInput.value && webSinceTimeInput.value) {
                since = `${webSinceDateInput.value}T${webSinceTimeInput.value}`;
            }
            if (webUntilDateInput.value && webUntilTimeInput.value) {
                until = `${webUntilDateInput.value}T${webUntilTimeInput.value}`;
            }
        }
        await loadWebLogs(since, until);
    }

    async function loadWebLogs(since = '', until = '') {
        let url = '/api/web-logs';
        const params = new URLSearchParams();
        if (since) {
            params.append('since', since);
        }
        if (until) {
            params.append('until', until);
        }
        const queryString = params.toString();
        if (queryString) {
            url += `?${queryString}`;
        }

        const res = await fetch(url);
        const data = await res.json();
        webLogItems.innerHTML = '';
        if (data && data.length > 0) {
            // Data is already sorted by timestamp descending from the server
            webLogItems.innerHTML = data.map(l => {
                const urlString = l[1];
                let domain = '';
                try {
                    const url = new URL(urlString);
                    domain = url.hostname;
                } catch (e) {}
                return `<div class="result-item"><input type="checkbox" name="web-log-domain" value="${domain}"> ${l.join(' | ')}</div>`;
            }).join('');
        } else {
            webLogItems.innerHTML = 'Chưa có lịch sử truy cập web.';
        }
    }

    async function blockSelectedWebsites() {
      const selectedDomains = Array.from(document.querySelectorAll('input[name="web-log-domain"]:checked')).map(cb => cb.value);
      if (selectedDomains.length === 0) {
        alert("Vui lòng chọn một trang web để chặn.");
        return;
      }
      
      const uniqueDomains = [...new Set(selectedDomains)];

      for (const domain of uniqueDomains) {
        await fetch('/api/web-blocklist/add', { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({ domain: domain })
        });
      }

      alert('Các trang web đã chọn đã được thêm vào danh sách chặn.');
      // Uncheck all boxes
      document.querySelectorAll('input[name="web-log-domain"]:checked').forEach(cb => cb.checked = false);
    }

    async function loadWebBlocklist() {
        const res = await fetch('/api/web-blocklist');
        const data = await res.json();
        webBlocklistItems.innerHTML = '';
        if (data && data.length > 0) {
            data.forEach(domain => {
                webBlocklistItems.innerHTML += `<div><input type="checkbox" name="blocked-website" value="${domain}"> ${domain} <button onclick="removeWebBlocklist('${domain}')">X</button></div>`;
            });
        } else {
            webBlocklistItems.innerHTML = 'Hiện không có trang web nào bị chặn.';
        }
    }

    async function removeWebBlocklist(domain) {
      if (confirm(`Bạn có chắc chắn muốn bỏ chặn ${domain} không?`)) {
        await fetch('/api/web-blocklist/remove', { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({ domain: domain })
        });
        loadWebBlocklist();
      }
    }

    async function unblockSelectedWebsites() {
        const selectedWebsites = Array.from(document.querySelectorAll('input[name="blocked-website"]:checked')).map(cb => cb.value);
        if (selectedWebsites.length === 0) {
            alert("Vui lòng chọn các trang web để bỏ chặn.");
            return;
        }
        for (const domain of selectedWebsites) {
            await fetch('/api/web-blocklist/remove', { 
              method: 'POST', 
              headers: {'Content-Type': 'application/json'}, 
              body: JSON.stringify({ domain: domain })
            });
        }
        document.getElementById('unblock-web-status').innerText = 'Đã bỏ chặn: ' + selectedWebsites.join(', ');
        setTimeout(() => { document.getElementById('unblock-web-status').innerText = ''; }, 3000);
        loadWebBlocklist(); // Refresh the list
    }

    async function clearWebBlocklist() {
        if (confirm("Bạn có chắc chắn muốn xóa toàn bộ danh sách chặn web không?")) {
            await fetch('/api/web-blocklist/clear', { method: 'POST' });
            document.getElementById('unblock-web-status').innerText = 'Đã xóa toàn bộ danh sách chặn web.';
            setTimeout(() => { document.getElementById('unblock-web-status').innerText = ''; }, 3000);
            loadWebBlocklist(); // Refresh the list
        }
    }

    async function saveWebBlocklist() {
        const response = await fetch('/api/web-blocklist/save');
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'procguard_web_blocklist.json';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    }

    async function loadWebBlocklistFile(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }
        const formData = new FormData();
        formData.append('file', file);

        await fetch('/api/web-blocklist/load', {
            method: 'POST',
            body: formData
        });

        document.getElementById('unblock-web-status').innerText = 'Đã tải lên và hợp nhất danh sách chặn web.';
        setTimeout(() => { document.getElementById('unblock-web-status').innerText = ''; }, 3000);
        loadWebBlocklist(); // Refresh the list
    }

    function checkExtension() {
      if (typeof chrome !== 'undefined' && chrome.runtime) {
        chrome.runtime.sendMessage(EXTENSION_ID, { message: 'is_installed' }, (response) => {
          if (chrome.runtime.lastError) {
            extensionStatus.textContent = 'Chưa cài đặt';
            installExtensionBtn.style.display = 'block';
          } else {
            extensionStatus.textContent = `Đã cài đặt (v${response.version})`;
            installExtensionBtn.style.display = 'none';
          }
        });
      } else {
        extensionStatus.textContent = 'Không phải trình duyệt dựa trên Chrome';
      }
    }

    async function search(range){
      let since = '';
      let until = '';

      if (range) {
        since = range.since;
        until = range.until;
      } else {
        if (sinceDateInput.value && sinceTimeInput.value) {
            since = `${sinceDateInput.value}T${sinceTimeInput.value}`;
        }
        if (untilDateInput.value && untilTimeInput.value) {
            until = `${untilDateInput.value}T${untilTimeInput.value}`;
        }
      }

      let url = '/api/search?q='+encodeURIComponent(q.value);
      if (since) {
        url += '&since=' + encodeURIComponent(since);
      }
      if (until) {
        url += '&until=' + encodeURIComponent(until);
      }
      const res = await fetch(url);
      const data = await res.json();
      if (data && data.length > 0) {
        results.innerHTML = data.map(l => {
            const processName = l[1];
            return `<div class="result-item"><input type="checkbox" name="search-result-app" value="${processName}"> ${l.join(' | ')}</div>`;
        }).join('');
      } else {
        results.innerHTML = "Không tìm thấy kết quả.";
      }
    }

    async function block(){
      const selectedApps = Array.from(document.querySelectorAll('input[name="search-result-app"]:checked')).map(cb => cb.value);
      if (selectedApps.length === 0) {
        alert("Vui lòng chọn một ứng dụng từ kết quả tìm kiếm để chặn.");
        return;
      }
      
      // Remove duplicates
      const uniqueApps = [...new Set(selectedApps)];

      await fetch('/api/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({names:uniqueApps})});
      blockStatus.innerText = 'Đã chặn: ' + uniqueApps.join(', ');
      setTimeout(() => { blockStatus.innerText = ''; }, 3000);
    }

    async function loadBlocklist() {
        const res = await fetch('/api/blocklist');
        const data = await res.json();
        blocklistItems.innerHTML = '';
        if (data && data.length > 0) {
            data.forEach(app => {
                blocklistItems.innerHTML += `<div><input type="checkbox" name="blocked-app" value="${app}"> ${app}</div>`;
            });
        } else {
            blocklistItems.innerHTML = 'Hiện không có ứng dụng nào bị chặn.';
        }
    }

    async function unblockSelected() {
        const selectedApps = Array.from(document.querySelectorAll('input[name="blocked-app"]:checked')).map(cb => cb.value);
        if (selectedApps.length === 0) {
            alert("Vui lòng chọn các ứng dụng để bỏ chặn.");
            return;
        }
        await fetch('/api/unblock', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({names: selectedApps})
        });
        unblockStatus.innerText = 'Đã bỏ chặn: ' + selectedApps.join(', ');
        setTimeout(() => { unblockStatus.innerText = ''; }, 3000);
        loadBlocklist(); // Refresh the list
    }

    async function clearBlocklist() {
        if (confirm("Bạn có chắc chắn muốn xóa toàn bộ danh sách chặn không?")) {
            await fetch('/api/blocklist/clear', { method: 'POST' });
            unblockStatus.innerText = 'Đã xóa toàn bộ danh sách chặn.';
            setTimeout(() => { unblockStatus.innerText = ''; }, 3000);
            loadBlocklist(); // Refresh the list
        }
    }

    async function saveBlocklist() {
        const response = await fetch('/api/blocklist/save');
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'procguard_blocklist.json';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    }

    async function loadBlocklistFile(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }
        const formData = new FormData();
        formData.append('file', file);

        await fetch('/api/blocklist/load', {
            method: 'POST',
            body: formData
        });

        unblockStatus.innerText = 'Đã tải lên và hợp nhất danh sách chặn.';
        setTimeout(() => { unblockStatus.innerText = ''; }, 3000);
        loadBlocklist(); // Refresh the list
    }

    async function uninstall() {
        uninstallModal.style.display = 'block';
    }

    function closeUninstallModal() {
        uninstallModal.style.display = 'none';
        uninstallError.style.display = 'none';
        uninstallPasswordInput.value = '';
    }

    uninstallForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const password = uninstallPasswordInput.value;

        const response = await fetch('/api/uninstall', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });

        if (response.ok) {
            closeUninstallModal();
            alert("ProcGuard đã được gỡ cài đặt. Trình duyệt sẽ đóng.");
            window.close();
        } else {
            uninstallError.textContent = "Gỡ cài đặt thất bại. Vui lòng kiểm tra lại mật khẩu.";
            uninstallError.style.display = 'block';
        }
    });

    // Set defaults and show the welcome view by default
    setDefaults();
    showTopLevelView('welcome-view');
    checkExtension();
  </script>
</body>
</html>