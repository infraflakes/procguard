<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Bảng điều khiển ProcGuard</title>
  <style>
    body{font-family:Arial,background:#f76f53;color:#000;margin:0;padding:2rem}
    button{background:#0bf;border:0;padding:.5rem 1rem;border-radius:4px;cursor:pointer}
    #results, #blocklist-items{height:400px;overflow-y:scroll;background:#e6e6e6;padding:1rem;font-size:13px;}
    #search-container, #blocklist-controls, #time-filter-container{margin-bottom: 1rem;}
    #time-filter-container > * { margin-right: 1rem; }
    nav > button { background: #333; color: #fff; }
    .status-message { margin-left: 1rem; padding: 5px; background: #333; color: #fff; border-radius: 3px; }
  </style>
</head>
<body>
  <nav>
    <button onclick="showView('search-view')">Tìm kiếm</button>
    <button onclick="showView('blocklist-view')">Xem ứng dụng bị chặn</button>
  </nav>

  <div id="search-view">
    <h2>Bảng điều khiển ProcGuard</h2>
    <div id="search-container">
      <input id="q" placeholder="nhập tên ứng dụng">
      <button onclick="search()">Tìm kiếm Log</button>
      <button onclick="block()">Chặn ứng dụng này</button>
      <span id="block-status" class="status-message"></span>
    </div>
    <div id="time-filter-container">
        <span>Lọc theo thời gian:</span>
        <button onclick="search({since: '1 hour ago', until: 'now'})">1 giờ qua</button>
        <button onclick="search({since: '24 hours ago', until: 'now'})">24 giờ qua</button>
        <button onclick="search({since: '7 days ago', until: 'now'})">7 ngày qua</button>
        <br>
        <span>Từ: </span><input type="date" id="since_date"> <input type="time" id="since_time" step="60">
        <span>Đến: </span><input type="date" id="until_date"> <input type="time" id="until_time" step="60">
        <button onclick="search()">Xác nhận</button>
    </div>
    <h3>Kết quả tìm kiếm</h3>
    <div id="results"></div>
  </div>

  <div id="blocklist-view" style="display:none;">
    <h2>Các ứng dụng bị chặn</h2>
    <div id="blocklist-controls">
        <button onclick="unblockSelected()">Bỏ chặn mục đã chọn</button>
        <span id="unblock-status" class="status-message"></span>
    </div>
    <div id="blocklist-items"></div>
  </div>

  <script>
    const results = document.getElementById('results');
    const q = document.getElementById('q');
    const sinceDateInput = document.getElementById('since_date');
    const sinceTimeInput = document.getElementById('since_time');
    const untilDateInput = document.getElementById('until_date');
    const untilTimeInput = document.getElementById('until_time');
    const blocklistItems = document.getElementById('blocklist-items');
    const searchView = document.getElementById('search-view');
    const blocklistView = document.getElementById('blocklist-view');
    const blockStatus = document.getElementById('block-status');
    const unblockStatus = document.getElementById('unblock-status');

    function setDefaults() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const today = `${year}-${month}-${day}`;
        sinceDateInput.value = today;
        untilDateInput.value = today;
    }

    function showView(viewName) {
        searchView.style.display = 'none';
        blocklistView.style.display = 'none';
        document.getElementById(viewName).style.display = 'block';

        if (viewName === 'blocklist-view') {
            loadBlocklist();
        }
    }

    async function search(range){
      let since = '';
      let until = '';

      if (range) {
        since = range.since;
        until = range.until;
      } else {
        if (sinceDateInput.value && sinceTimeInput.value) {
            since = `${sinceDateInput.value}T${sinceTimeInput.value}`;
        }
        if (untilDateInput.value && untilTimeInput.value) {
            until = `${untilDateInput.value}T${untilTimeInput.value}`;
        }
      }

      let url = '/api/search?q='+encodeURIComponent(q.value);
      if (since) {
        url += '&since=' + encodeURIComponent(since);
      }
      if (until) {
        url += '&until=' + encodeURIComponent(until);
      }
      const res = await fetch(url);
      const data = await res.json();
      if (data && data.length > 0) {
        results.innerHTML = data.map(l=>l.join(' | ')).join('<br>');
      } else {
        results.innerHTML = "Không tìm thấy kết quả.";
      }
    }

    async function block(){
      const app = q.value;
      if (!app) {
        alert("Vui lòng nhập tên ứng dụng để chặn.");
        return;
      }
      await fetch('/api/block',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:app})});
      blockStatus.innerText = 'Đã chặn ' + app;
      setTimeout(() => { blockStatus.innerText = ''; }, 3000);
    }

    async function loadBlocklist() {
        const res = await fetch('/api/blocklist');
        const data = await res.json();
        blocklistItems.innerHTML = '';
        if (data && data.length > 0) {
            data.forEach(app => {
                blocklistItems.innerHTML += `<div><input type="checkbox" name="blocked-app" value="${app}"> ${app}</div>`;
            });
        } else {
            blocklistItems.innerHTML = 'Hiện không có ứng dụng nào bị chặn.';
        }
    }

    async function unblockSelected() {
        const selectedApps = Array.from(document.querySelectorAll('input[name="blocked-app"]:checked')).map(cb => cb.value);
        if (selectedApps.length === 0) {
            alert("Vui lòng chọn các ứng dụng để bỏ chặn.");
            return;
        }
        await fetch('/api/unblock', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({names: selectedApps})
        });
        unblockStatus.innerText = 'Đã bỏ chặn: ' + selectedApps.join(', ');
        setTimeout(() => { unblockStatus.innerText = ''; }, 3000);
        loadBlocklist(); // Refresh the list
    }

    // Set defaults and show search view by default
    setDefaults();
    showView('search-view');
  </script>
</body>
</html>